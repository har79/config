#!/bin/bash
set -eu

function print_usage() {
  echo "Usage: npx har79-config [OPT].. [PATTERN].." >&2
}

function print_help() {
  print_usage
  cat >&2 <<END

OPT
  -d    Debug; prints all subcommands.
  -f    Force; replace all links.
  -h    Print this help.
  -n    Dry run; list changes and exit.
END
}

while getopts ":dfhn" o; do
  case "${o}" in
    d)
      set -x
      ;;
    f)
      declare -r FORCE="-f"
      ;;
    h)
      print_help
      exit 1
      ;;
    n)
      declare -r DRY_RUN=true
      ;;
    *)
      print_usage
      exit 1
      ;;
  esac
done
shift $((OPTIND-1))

function run() {
  ${DRY_RUN:+echo} $@
}

function copy() {
  run cp ${FORCE:--n} "${1#"${PWD}/"}" "$2"
}

function link() {
  run ln -s ${FORCE:-} "${1#"${PWD}/"}" "$2"
}

declare -r SELF="$(realpath "$0")"
declare -r DIR="$(dirname "${SELF}")"

declare -r PATTERNS=( "${@:-"*"}" )
declare -r EXCLUDE=(
  "$(basename "$SELF")"
  "ignore"
  "package.json"
  "LICENSE"
  "README.md"
)

declare cmd=()

function add_names() {
  cmd+=( \( -false )
  for name in "$@"; do
    cmd+=(-or -name "*${name}*")
  done
  cmd+=( \) )
}

cmd+=(
  find "${DIR}"
      -maxdepth 1
      -not -type d
      -not ) 

add_names "${EXCLUDE[@]}"

add_names "${PATTERNS[@]}"

"${cmd[@]}" | while read file; do
  if [[ "${file}" == *options.config.js ]]; then
    copy ${file} .
    continue
  fi
  link "${file}" .
done

for pattern in "${PATTERNS[@]}"; do
  if [[ ".gitignore" == ${pattern} ]]; then
    link "${DIR}/.npmignore" .gitignore
    break
  fi
done

for ignore in .eslintignore .hgignore .prettierignore; do
  for pattern in "${PATTERNS[@]}"; do
    if [[ "${ignore}" == ${pattern} ]]; then
      link .gitignore "${ignore}"
      break
    fi
  done
done
